{"version":3,"sources":["../../src/components/sorter.ts"],"sourcesContent":["import { createError } from '../errors.js'\nimport { ISorter, OpaqueSorter, Orama, Schema, SorterConfig, SorterParams, SortType, SortValue } from '../types.js'\nimport {\n  DocumentID,\n  getInternalDocumentId,\n  InternalDocumentID,\n  InternalDocumentIDStore,\n} from './internal-document-id-store.js'\n\ninterface PropertySort<K> {\n  docs: Map<InternalDocumentID, number>\n  orderedDocs: [InternalDocumentID, K][]\n  orderedDocsToRemove: Map<InternalDocumentID, boolean>\n  type: SortType\n}\n\ntype SerializablePropertySort<K> = Omit<PropertySort<K>, 'orderedDocsToRemove' | 'docs'> & {\n  docs: Record<string, number>\n}\n\nexport interface Sorter extends OpaqueSorter {\n  sharedInternalDocumentStore: InternalDocumentIDStore\n  isSorted: boolean\n  language: string\n  enabled: boolean\n  sortableProperties: string[]\n  sortablePropertiesWithTypes: Record<string, SortType>\n  sorts: Record<string, PropertySort<number | string | boolean>>\n}\n\nexport type DefaultSorter = ISorter<Sorter>\n\nfunction innerCreate(\n  orama: Orama,\n  sharedInternalDocumentStore: InternalDocumentIDStore,\n  schema: Schema,\n  sortableDeniedProperties: string[],\n  prefix: string,\n): Sorter {\n  const sorter: Sorter = {\n    language: orama.tokenizer.language,\n    sharedInternalDocumentStore,\n    enabled: true,\n    isSorted: true,\n    sortableProperties: [],\n    sortablePropertiesWithTypes: {},\n    sorts: {},\n  }\n\n  for (const [prop, type] of Object.entries(schema)) {\n    const typeActualType = typeof type\n    const path = `${prefix}${prefix ? '.' : ''}${prop}`\n\n    if (sortableDeniedProperties.includes(path)) {\n      continue\n    }\n\n    if (typeActualType === 'object' && !Array.isArray(type)) {\n      // Nested\n      const ret = innerCreate(orama, sharedInternalDocumentStore, type as Schema, sortableDeniedProperties, path)\n      sorter.sortableProperties.push(...ret.sortableProperties)\n      sorter.sorts = {\n        ...sorter.sorts,\n        ...ret.sorts,\n      }\n      sorter.sortablePropertiesWithTypes = {\n        ...sorter.sortablePropertiesWithTypes,\n        ...ret.sortablePropertiesWithTypes,\n      }\n      continue\n    }\n\n    switch (type) {\n      case 'boolean':\n      case 'number':\n      case 'string':\n        sorter.sortableProperties.push(path)\n        sorter.sortablePropertiesWithTypes[path] = type\n        sorter.sorts[path] = {\n          docs: new Map(),\n          orderedDocsToRemove: new Map(),\n          orderedDocs: [],\n          type: type,\n        }\n        break\n      case 'boolean[]':\n      case 'number[]':\n      case 'string[]':\n        // We don't allow to sort by arrays\n        continue\n      default:\n        throw createError('INVALID_SORT_SCHEMA_TYPE', Array.isArray(type) ? 'array' : (type as unknown as string), path)\n    }\n  }\n\n  return sorter\n}\n\nasync function create(\n  orama: Orama,\n  sharedInternalDocumentStore: InternalDocumentIDStore,\n  schema: Schema,\n  config?: SorterConfig,\n): Promise<Sorter> {\n  const isSortEnabled = config?.enabled !== false\n  if (!isSortEnabled) {\n    return {\n      disabled: true,\n    } as unknown as Sorter\n  }\n  return innerCreate(orama, sharedInternalDocumentStore, schema, (config || {}).unsortableProperties || [], '')\n}\n\nasync function insert(sorter: Sorter, prop: string, id: DocumentID, value: SortValue): Promise<void> {\n  if (!sorter.enabled) {\n    return\n  }\n\n  sorter.isSorted = false\n\n  const internalId = getInternalDocumentId(sorter.sharedInternalDocumentStore, id)\n  const s = sorter.sorts[prop]\n\n  s.docs.set(internalId, s.orderedDocs.length)\n  s.orderedDocs.push([internalId, value])\n}\n\nfunction ensureIsSorted(sorter: Sorter): void {\n  if (sorter.isSorted) {\n    return\n  }\n\n  if (!sorter.enabled) {\n    return\n  }\n\n  const properties = Object.keys(sorter.sorts)\n  for (const prop of properties) {\n    ensurePropertyIsSorted(sorter, prop)\n  }\n\n  sorter.isSorted = true\n}\n\nfunction stringSort(\n  language: string | undefined,\n  value: [InternalDocumentID, SortValue],\n  d: [InternalDocumentID, SortValue],\n): number {\n  return (value[1] as string).localeCompare(d[1] as string, language)\n}\n\nfunction numberSort(value: [InternalDocumentID, SortValue], d: [InternalDocumentID, SortValue]): number {\n  return (value[1] as number) - (d[1] as number)\n}\n\nfunction booleanSort(value: [InternalDocumentID, SortValue], d: [InternalDocumentID, SortValue]): number {\n  return (d[1] as boolean) ? -1 : 1\n}\n\nfunction ensurePropertyIsSorted(sorter: Sorter, prop: string): void {\n  const s = sorter.sorts[prop]\n\n  let predicate: (value: [InternalDocumentID, SortValue], d: [InternalDocumentID, SortValue]) => number\n  switch (s.type) {\n    case 'string':\n      predicate = stringSort.bind(null, sorter.language)\n      break\n    case 'number':\n      predicate = numberSort.bind(null)\n      break\n    case 'boolean':\n      predicate = booleanSort.bind(null)\n      break\n  }\n\n  s.orderedDocs.sort(predicate)\n\n  // Increment position for the greather documents\n  const orderedDocsLength = s.orderedDocs.length\n  for (let i = 0; i < orderedDocsLength; i++) {\n    const docId = s.orderedDocs[i][0]\n    s.docs.set(docId, i)\n  }\n}\n\nfunction ensureOrderedDocsAreDeleted(sorter: Sorter): void {\n  const properties = Object.keys(sorter.sorts)\n  for (const prop of properties) {\n    ensureOrderedDocsAreDeletedByProperty(sorter, prop)\n  }\n}\n\nfunction ensureOrderedDocsAreDeletedByProperty(sorter: Sorter, prop: string): void {\n  const s = sorter.sorts[prop]\n\n  if (!s.orderedDocsToRemove.size) return\n\n  s.orderedDocs = s.orderedDocs.filter(doc => !s.orderedDocsToRemove.has(doc[0]))\n  s.orderedDocsToRemove.clear()\n}\n\nasync function remove(sorter: Sorter, prop: string, id: DocumentID) {\n  if (!sorter.enabled) {\n    return\n  }\n  const s = sorter.sorts[prop] as PropertySort<SortValue>\n  const internalId = getInternalDocumentId(sorter.sharedInternalDocumentStore, id)\n\n  const index = s.docs.get(internalId)\n\n  if (!index) return\n\n  s.docs.delete(internalId)\n  s.orderedDocsToRemove.set(internalId, true)\n}\n\nasync function sortBy(\n  sorter: Sorter,\n  docIds: [DocumentID, number][],\n  by: SorterParams,\n): Promise<[DocumentID, number][]> {\n  if (!sorter.enabled) {\n    throw createError('SORT_DISABLED')\n  }\n\n  const property = by.property\n  const isDesc = by.order === 'DESC'\n\n  const s = sorter.sorts[property]\n  if (!s) {\n    throw createError('UNABLE_TO_SORT_ON_UNKNOWN_FIELD', property, sorter.sortableProperties.join(', '))\n  }\n\n  ensureOrderedDocsAreDeletedByProperty(sorter, property)\n  ensureIsSorted(sorter)\n\n  docIds.sort((a, b) => {\n    // This sort algorithm works leveraging on\n    // that s.docs is a map of docId -> position\n    // If a document is not indexed, it will be not present in the map\n    const indexOfA = s.docs.get(getInternalDocumentId(sorter.sharedInternalDocumentStore, a[0]))\n    const indexOfB = s.docs.get(getInternalDocumentId(sorter.sharedInternalDocumentStore, b[0]))\n    const isAIndexed = typeof indexOfA !== 'undefined'\n    const isBIndexed = typeof indexOfB !== 'undefined'\n\n    if (!isAIndexed && !isBIndexed) {\n      return 0\n    }\n    // unindexed documents are always at the end\n    if (!isAIndexed) {\n      return 1\n    }\n    if (!isBIndexed) {\n      return -1\n    }\n\n    return isDesc ? indexOfB - indexOfA : indexOfA - indexOfB\n  })\n\n  return docIds\n}\n\nasync function getSortableProperties(sorter: Sorter): Promise<string[]> {\n  if (!sorter.enabled) {\n    return []\n  }\n\n  return sorter.sortableProperties\n}\n\nasync function getSortablePropertiesWithTypes(sorter: Sorter): Promise<Record<string, SortType>> {\n  if (!sorter.enabled) {\n    return {}\n  }\n\n  return sorter.sortablePropertiesWithTypes\n}\n\nexport async function load<R = unknown>(sharedInternalDocumentStore: InternalDocumentIDStore, raw: R): Promise<Sorter> {\n  const rawDocument = raw as Omit<Sorter, 'sorts'> & {\n    sorts: Record<string, SerializablePropertySort<string | number | boolean>>\n  }\n  if (!rawDocument.enabled) {\n    return {\n      enabled: false,\n    } as unknown as Sorter\n  }\n\n  const sorts = Object.keys(rawDocument.sorts).reduce((acc, prop) => {\n    const { docs, orderedDocs, type } = rawDocument.sorts[prop]\n\n    acc[prop] = {\n      docs: new Map(Object.entries(docs).map(([k, v]) => [+k, v])),\n      orderedDocsToRemove: new Map(),\n      orderedDocs,\n      type,\n    }\n\n    return acc\n  }, {} as Record<string, PropertySort<string | number | boolean>>)\n\n  return {\n    sharedInternalDocumentStore,\n    language: rawDocument.language,\n    sortableProperties: rawDocument.sortableProperties,\n    sortablePropertiesWithTypes: rawDocument.sortablePropertiesWithTypes,\n    sorts,\n    enabled: true,\n    isSorted: rawDocument.isSorted,\n  }\n}\n\nexport async function save<R = unknown>(sorter: Sorter): Promise<R> {\n  if (!sorter.enabled) {\n    return {\n      enabled: false,\n    } as unknown as R\n  }\n\n  ensureOrderedDocsAreDeleted(sorter)\n  ensureIsSorted(sorter)\n\n  const sorts = Object.keys(sorter.sorts).reduce((acc, prop) => {\n    const { docs, orderedDocs, type } = sorter.sorts[prop]\n\n    acc[prop] = {\n      docs: Object.fromEntries(docs.entries()),\n      orderedDocs,\n      type,\n    }\n\n    return acc\n  }, {} as Record<string, SerializablePropertySort<string | number | boolean>>)\n\n  return {\n    language: sorter.language,\n    sortableProperties: sorter.sortableProperties,\n    sortablePropertiesWithTypes: sorter.sortablePropertiesWithTypes,\n    sorts,\n    enabled: sorter.enabled,\n    isSorted: sorter.isSorted,\n  } as R\n}\n\nexport async function createSorter(): Promise<DefaultSorter> {\n  return {\n    create,\n    insert,\n    remove,\n    save,\n    load,\n    sortBy,\n    getSortableProperties,\n    getSortablePropertiesWithTypes,\n  }\n}\n"],"names":["createError","getInternalDocumentId","innerCreate","orama","sharedInternalDocumentStore","schema","sortableDeniedProperties","prefix","sorter","language","tokenizer","enabled","isSorted","sortableProperties","sortablePropertiesWithTypes","sorts","prop","type","Object","entries","typeActualType","path","includes","Array","isArray","ret","push","docs","Map","orderedDocsToRemove","orderedDocs","create","config","isSortEnabled","disabled","unsortableProperties","insert","id","value","internalId","s","set","length","ensureIsSorted","properties","keys","ensurePropertyIsSorted","stringSort","d","localeCompare","numberSort","booleanSort","predicate","bind","sort","orderedDocsLength","i","docId","ensureOrderedDocsAreDeleted","ensureOrderedDocsAreDeletedByProperty","size","filter","doc","has","clear","remove","index","get","delete","sortBy","docIds","by","property","isDesc","order","join","a","b","indexOfA","indexOfB","isAIndexed","isBIndexed","getSortableProperties","getSortablePropertiesWithTypes","load","raw","rawDocument","reduce","acc","map","k","v","save","fromEntries","createSorter"],"mappings":"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"}